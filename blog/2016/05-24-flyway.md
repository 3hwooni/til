# 2016-05-24 - Flyway로 DB 스키마 관리하기

## DB 스키마 관리의 필요성

고전적인 애플리케이션 개발과 인터넷 애플리케이션 개발의 큰 차이점 중 하나는 다양한 외부 시스템과 연동된다는 점이 있습니다. 웹 서비스의 경우 DBMS를 쓰지 않는 경우는 없다고 봐도 되고, 애플리케이션 소스코드 외에 DB 스키마와 Seeding 데이터를 관리하는 건 중요한 이슈가 되었습니다.

기존 DB를 사용하지 않는 새로운 개발 환경 또는 배포 환경을 세팅했을 때, 올바르게 애플리케이션을 작동시키려면 DB 스키마가 필요합니다. 쉽게 말하면 DB 테이블을 만들 수 있어야 합니다. 간단한 `SELECT` 명령을 실행했을 때 “테이블을 찾을 수 없습니다” 또는 “해당 테이블에 존재하지 않는 컬럼입니다” 같은 에러를 내지 않게 하려면 반드시 올바른 DB 스키마를 공유해야 합니다.

그래서 현대적인 애플리케이션 개발 환경에선 DB 스키마와 Seeding 데이터를 소스코드 저장소(Git 등)에 함께 포함시킵니다.

## DB 스키마 변화 관리의 필요성

문제는 DB 스키마가 종종 변한다는 겁니다. 새로운 기능을 추가하기 위해 DB 테이블에 컬럼을 추가하는 건 흔한 일입니다. `mysqldump` 등으로 만든 일반적인 스키마 파일은 `DROP TABLE`과 `CREATE TABLE`을 반복함으로써 이 문제를 해결합니다. 기존 데이터를 지워도 되는 경우라면 가능한 방법이지만, 이미 사용자에게 서비스를 제공하고 있다면 절대 사용할 수 없는 방법이죠.

이 문제를 해결하기 위해 따로 `ALTER TABLE ... ADD ...` 같은 걸 따로 실행하고 스키마 파일을 업데이트하는 경우가 많습니다. 이렇게 하면 서비스 중인 환경은 유지할 수 있지만, 다른 환경(예를 들어 개발자의 로컬 DB)이 올바르다고 보장하기 어렵습니다. “이거 바뀌었으니 실행해 주세요”라고 공지하는 것만으론 충분하지 않을 수 있습니다.

게다가 새로 추가된 컬럼이 어떤 연산을 통해 새로운 값을 가져야 하거나, 새로운 테이블을 만들어 기존 데이터를 옮기거나 하는 좀더 복잡한 작업이 되면 간단한 공지로 끝나지 않을 수 있습니다.

그래서 현대적인 애플리케이션 개발 환경에선 단일 DB 스키마가 아니라, 변화를 다루는 마이그레이션 스크립트를 만들어 사용합니다. 소스코드 저장소에 함께 포함시키고, 모든 환경에서 서버를 구동하기 전에 적용시키죠.

## Flyway

Flyway([https://flywaydb.org/](http://j.mp/1U7xODX))는 이런 DB 마이그레이션을 간단히 할 수 있게 도와주는 도구입니다. Flyway는 [그냥 SQL을 사용](http://j.mp/1RmBLD6)할 수도 있고, [Java를 사용](http://j.mp/1YUDaqj)할 수도 있습니다(심지어 Spring의 JdbcTemplate도 쓸 수 있습니다). 테이블 생성/삭제/변경 등 단순 작업은 SQL로 작성하고, 복잡한 연산 등은 Java 코드를 작성해서 처리할 수 있게 한 거죠.

각 마이그레이션 파일은 “버전”을 가지고, 이 버전 순서에 따라 실행됩니다(정확히는 가장 마지막으로 적용된 버전 이후의 마이그레이션이 실행됩니다). 버전을 관리하는 다른 도구를 쓰지 않고, 파일명으로 구분하게 되어 있습니다. Flyway는 “단순함”을 지향합니다.

Ruby on Rails 등이 제공하는 DB Migration은 “되돌리기”를 지원하지만, [Flyway는 되돌리기를 지원하지 않습니다](http://j.mp/1U7xjcV). 가역성을 보장하지 않는 마이그레이션 작업이 많고, 되돌리기는 자주 실패합니다. 억지로 되돌리는 스크립트를 작성할 수도 있지만, Flyway는 “단순함”을 선택했습니다. Rails 등의 마이그레이션에 익숙한 분들은 조금 다르게 사용하셔야 합니다.

## Gradle 플러그인

Flyway를 실행하는 방법은 다양합니다. 커맨드라인에서 실행할 수도 있고, Java API로 실행할 수도 있습니다. [Gradle 플러그인으로 통합해서 사용할 수도 있습니다](http://j.mp/1OTC91w). 심지어 [Spring Boot와 통합됩니다](http://j.mp/1TtLM9f).

이 글에서는 Gradle 플러그인을 사용하도록 하겠습니다.

## Baseline

Flyway를 통해 마이그레이션을 실행하면 모든 마이그레이션 파일을 실행하는 게 아니라, 마지막으로 실행한 마이그레이션 버전 이후의 마이그레이션 파일만 실행합니다. “변경된” 것만 반영하는 거죠.

그렇게 하기 위해 Flyway는 스키마 버전을 담고 있는 테이블(테이블명: `schema_version`)을 만들어서 관리합니다. `schema_version` 테이블을 만드는 작업을 Baseline이라고 합니다. [Gradle Task flywayBaseline](http://j.mp/1sNJrKG)을 사용하면 됩니다.

```
$ ./gradlew flywayBaseline -i
```

`-i` 옵션은 마이그레이션 과정을 상세히 보여줍니다. 스키마 버전 테이블이 만들어지고, 버전이 1로 설정된 것을 확인하실 수 있습니다.

기존에 있던 스키마를 `schema.sql`로 추출하고 다음과 같이 버전 1 파일을 만들어 줍니다.

```
$ mkdir -p src/main/resources/db/migration   # Spring 프로젝트 기준입니다.
$ cp schema.sql src/main/resources/db/migration/V1__schema.sql   # 버전 1로 잡아줍니다.
```

## Migration

이제 DB 스키마가 바뀔 때마다 마이그레이션 파일을 만들어 줍니다. 간단한 예제를 만들어 보겠습니다.

```
$ vi src/main/resources/db/migration/V2__Create_person_table.sql  # 버전에 주의하세요.

CREATE TABLE person (
  id BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '기본 키',
  name VARCHAR(100) NOT NULL COMMENT '이름',
  PRIMARY KEY (id)
);
```

[Gradle Task flywayMigrate](http://j.mp/1WPr8S3)를 실행해 DB에 반영합니다.

```
$ ./gradlew flywayMigrate -i
```

실패했을 땐 [Gradle Task flywayRepair](http://j.mp/1VgxsQI)를 실행해서 문제를 제거할 수 있습니다. 당연히 문제가 되는 마이그레이션 파일도 수정해줘야 합니다.

```
$ ./gradlew flywayRepair -i
```

## 까먹지 않기

거창한 이야기가 많았지만, 결국은 까먹지 않고 DB 스키마가 바뀔 때마다 해당 명령을 SQL 등으로 작성해 파일로 만들어 추가하는 게 중요합니다. 소스코드 저장소에 포함시키기 때문에 CI 등에서 검증한다면 언제 어디서나 항상 올바르게 DB 스키마를 최신으로 유지할 수 있을 겁니다.
